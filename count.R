
##b3!=0
N<-c(250,1000,5000)
rho<-c(0,.5) #rho<-seq(0,.3,by=.1)
b0<-0#c(0,2)
b3<-seq(0,.15,by=.01)
pars<-expand.grid(N=N,rho=rho,b0=b0,b3=b3)
tmp<-list()
for (i in 1:nrow(pars)) tmp[[i]]<-pars[i,]
pars<-tmp

simfun<-function(pars,b1=1,b2=1) {
    for (i in 1:length(pars)) assign(names(pars)[i],pars[[i]][1])
    library(MASS)
    r2<-sig0<-sig<-numeric()
    for (i in 1:1000) {
        xz<-mvrnorm(N,mu=c(0,0),Sigma=matrix(c(1,rho,rho,1),2,2))
        y<-b0+b1*xz[,1]+b2*xz[,2]+b3*xz[,1]*xz[,2]
        y<-exp(y)
        y<-rpois(N,y)
        df<-data.frame(y=y,x=xz[,1],z=xz[,2])
        ##
        m<-glm(y~x*z,df,family="poisson")
        pv<-summary(m)$coef[4,4]
        sig[i]<-ifelse(pv<.05,1,0)
        m0<-glm(y~x+z,df,family="poisson")
        m.lm<-lm(y~x*z,df)
        pv<-summary(m.lm)$coef[4,4]
        sig0[i]<-ifelse(pv<.05,1,0)
        ##
        Noos<-1000
        xz<-mvrnorm(Noos,mu=c(0,0),Sigma=matrix(c(1,rho,rho,1),2,2))
        y<-b1*xz[,1]+b2*xz[,2]+b3*xz[,1]*xz[,2]
        y<-exp(y)
        y<-rpois(Noos,y)
        df<-data.frame(y=y,x=xz[,1],z=xz[,2])
        yhat<-predict(m,df,type='response')
        y0hat<-predict(m0,df,type='response')
        r2[i]<- (var(y0hat-y)-var(yhat-y))/var(y)
    }
    c(N,rho,b0,b3,mean(sig),mean(sig0),mean(r2))
}
library(parallel)
out<-mclapply(pars,simfun,mc.cores=25)
tab<-do.call("rbind",out)

pdf("/home/bd/Dropbox/Apps/Overleaf/Interaction_problems/count2.pdf",width=6,height=2.3)
source("/home/bd/Dropbox/projects/interaction_problems/src/000_functions.R")
L<-split(data.frame(tab),tab[,1])
layout(matrix(c(4,rep(1,3),4,rep(2,3),4,rep(3,3)),byrow=FALSE,nrow=4,ncol=3))
par(mgp=c(2,1,0),mar=c(3,3,.5,.5))
for (ii in 1:length(L)) {
    zz<-split(L[[ii]],L[[ii]][,2])
    plot(NULL,xlim=c(0,.15),ylim=0:1,xlab=expression(beta[3]),ylab='Discovery Rate')
    vert()
    cols<-colorRampPalette(c("red", "blue"))( length(zz))
    for (i in 1:length(zz)) {
        tmp.both<-zz[[i]]
        ##split by b0
        tmp<-tmp.both[tmp.both[,3]==0,]
        lines(tmp[,4],tmp[,5],col=cols[i],lwd=2)
        lines(tmp[,4],tmp[,6],col=cols[i],lwd=2,lty=2)
    }
    legend("bottomright",bty='n',paste("N=",unique(tmp[,1]),sep=''),xjust=.5,yjust=.5)
    abline(h=.8,col='gray')
    #if (ii==1) legend("topright",bty='n',lty=c(1,2),title=expression(beta[0]),as.character(c(0,2)))
    ##
    xx<-L[[ii]]
    mm<-loess(xx[,7]~xx[,4])
    co<-coef(mm)
    vals<-seq(0,max(xx[,4]),by=.05)
    #axis(side=3,at=vals,formatC(predict(mm,vals),digits=0))
    #mtext(side=3,line=2,expression(r^2),cex=.7)
}
par(mar=rep(0,4))
plot(NULL,xlim=0:1,ylim=0:1,bty='n',xaxt='n',yaxt='n',xlab='',ylab='')
legend(xjust=.5,yjust=.5,x=.3,y=0.5,bty='n',names(zz),fill=cols,title=expression(rho))
legend(xjust=.5,yjust=.5,x=.1,y=0.5,bty='n',lwd=2,lty=c(1,2),c("Poisson","Linear"))
dev.off()

tab <-
structure(c(250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 
250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 
5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 
1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 
250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 
5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 
1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 
250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 
5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 0, 0, 
0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 
0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 
0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 
0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 
0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 
0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 
0.5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.01, 
0.01, 0.01, 0.01, 0.01, 0.01, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 
0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.04, 0.04, 0.04, 0.04, 0.04, 
0.04, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.06, 0.06, 0.06, 0.06, 
0.06, 0.06, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.08, 0.08, 0.08, 
0.08, 0.08, 0.08, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.1, 0.1, 
0.1, 0.1, 0.1, 0.1, 0.11, 0.11, 0.11, 0.11, 0.11, 0.11, 0.12, 
0.12, 0.12, 0.12, 0.12, 0.12, 0.13, 0.13, 0.13, 0.13, 0.13, 0.13, 
0.14, 0.14, 0.14, 0.14, 0.14, 0.14, 0.15, 0.15, 0.15, 0.15, 0.15, 
0.15, 0.051, 0.048, 0.045, 0.052, 0.043, 0.058, 0.063, 0.089, 
0.197, 0.065, 0.1, 0.339, 0.08, 0.156, 0.613, 0.073, 0.226, 0.847, 
0.096, 0.322, 0.934, 0.124, 0.444, 0.992, 0.146, 0.484, 0.993, 
0.21, 0.671, 0.999, 0.206, 0.673, 1, 0.286, 0.838, 1, 0.274, 
0.804, 1, 0.375, 0.937, 1, 0.345, 0.902, 1, 0.445, 0.978, 1, 
0.441, 0.966, 1, 0.571, 0.995, 1, 0.518, 0.988, 1, 0.639, 0.994, 
1, 0.589, 0.989, 1, 0.738, 0.998, 1, 0.657, 0.999, 1, 0.799, 
1, 1, 0.74, 0.999, 1, 0.841, 1, 1, 0.776, 1, 1, 0.89, 1, 1, 0.836, 
1, 1, 0.906, 1, 1, 0.872, 1, 1, 0.921, 1, 1, 1, 1, 1, 1, 1, 1, 
1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
1, 1, 1, 1, 1, 1, -0.00658099380316119, -0.0012061949140488, 
-0.000131928274698871, -0.0097417918943191, -0.00111394092984276, 
-0.000149952885275011, -0.00964581748687582, -0.00113623792624979, 
9.03667067865048e-05, -0.00847557362287822, -0.000823001793448447, 
-7.9663756877424e-07, -0.00496955813278268, 5.93482467290699e-05, 
0.000463221913780429, -0.00901986171859429, 9.77949858361781e-05, 
0.000598246109518967, -0.00633667253962465, 0.000329242793269316, 
0.00111962706597432, -0.0112632983444151, 0.000825701976927071, 
0.00146242337515786, -0.00642968698209903, 0.00181409833568448, 
0.00230641769886612, -0.00650735937013296, 0.00285755938141945, 
0.00273598995726906, -0.00577720665961149, 0.0038786830697764, 
0.00404292668803064, -0.00354143436764093, 0.00446390923333374, 
0.00408389307384421, -0.00157183129339924, 0.00475821221244728, 
0.00516642313515631, 0.000170048050697925, 0.00699578517267637, 
0.00576427887883367, 0.000472511508684347, 0.00767083880163851, 
0.00696083886811444, 0.00428664039084675, 0.00941104742866049, 
0.0074871565052661, 0.00444679846949196, 0.00926237758889503, 
0.00954553129851689, 0.0100752066896521, 0.0126662436235323, 
0.0095903195867304, 0.0115543800160107, 0.0120371166050532, 0.00989713428776038, 
0.0136621382766622, 0.0154249601341033, 0.0109363400805526, 0.0112404169539654, 
0.0153937574220313, 0.0139834370599885, 0.0125105346273217, 0.0190697564493068, 
0.0137965059666959, 0.0154599721905113, 0.0203647985312975, 0.0156730815848965, 
0.0256393084864897, 0.0226067698173276, 0.0156211865982579, 0.0200772501771563, 
0.0223493547202185, 0.0178973303290045, 0.0322224408413426, 0.0248727815035677, 
0.0164441595035541, 0.0251363429013832, 0.0255923595629207, 0.0214791732046597, 
0.035986767245568, 0.0267246273930924, 0.0197020980968136, 0.0285026065388605, 
0.0299144474716905, 0.0243951939770101, 0.0439186888006278, 0.0307008030753379, 
0.0225812907395151, 0.0355757211192326, 0.0320826612899673, 0.0277476914079933, 
0.053368005264989, 0.0353920653846081, 0.0243270708135008), .Dim = c(96L, 
7L))
