
## ##b3=0
## out<-list()
## std<-function(x) (x-mean(x,na.rm=TRUE))/sd(x,na.rm=TRUE)
## for (N in c(250,1000,5000)) {
##     print(N)
##     for (rho in seq(0,.3,by=.1)) {
##         for (b0 in c(0,1,5)) {
##             ##inside
##             sig<-numeric()
##             for (i in 1:250) {
##                 library(MASS)
##                 xz<-mvrnorm(N,mu=c(0,0),Sigma=matrix(c(1,rho,rho,1),2,2))
##                 b1<-1
##                 b2<-1
##                 y<-b0+b1*xz[,1]+b2*xz[,2]+rnorm(N)
##                 sigma<-function(z) 1/(1+exp(-z))
##                 p<-sigma(y)
##                 y<-rbinom(N,1,p)
##                 ##
##                 df<-data.frame(y=y,x=xz[,1],z=xz[,2])
##                 m<-glm(y~x*z,df,family="binomial")
##                 pv<-summary(m)$coef[4,4]
##                 sig[i]<-ifelse(pv<.05,1,0)
##             }
##             out[[paste(N,rho,b0)]]<-c(N,rho,b0,mean(sig))
##             ##
##         }
##     }
## }
## tab<-do.call("rbind",out)

## L<-split(data.frame(tab),tab[,1])
## pdf("/home/bd/Dropbox/Apps/Overleaf/Interaction_problems/binary1.pdf",width=8,height=3)
## par(mgp=c(2,1,0),mfrow=c(1,3),mar=c(3,3,1,1))
## for (ii in 1:length(L)) {
##     zz<-split(L[[ii]],L[[ii]][,2])
##     plot(NULL,xlim=c(0,5),ylim=0:1,xlab=expression(beta[0]),ylab='FDR')
##     cols<-colorRampPalette(c("red", "blue"))( length(zz))
##     for (i in 1:length(zz)) {
##         tmp<-zz[[i]]
##         lines(tmp[,3],tmp[,4],col=cols[i],lwd=2)
##     }
##     legend("topleft",bty='n',paste("N=",unique(tmp[,1]),sep=''))
##     legend("topright",bty='n',names(zz),fill=cols,title=expression(rho))
##     abline(h=.05,col='gray')
## }
## dev.off()


##b3!=0
N<-c(250,1000,5000)
rho<-c(0,.5) #rho<-seq(0,.3,by=.1)
b0<-c(0,2)
b3<-seq(0,0.3,by=.025)
pars<-expand.grid(N=N,rho=rho,b0=b0,b3=b3)
tmp<-list()
for (i in 1:nrow(pars)) tmp[[i]]<-pars[i,]
pars<-tmp

simfun<-function(pars,b1=1,b2=1) {
    for (i in 1:length(pars)) assign(names(pars)[i],pars[[i]][1])
    library(MASS)
    r2<-sig<-sig.lm<-numeric()
    for (i in 1:1000) {
        xz<-mvrnorm(N,mu=c(0,0),Sigma=matrix(c(1,rho,rho,1),2,2))
        y<-b0+b1*xz[,1]+b2*xz[,2]+b3*xz[,1]*xz[,2]
        sigma<-function(z) 1/(1+exp(-z))
        p<-sigma(y)
        y<-rbinom(N,1,p)
        df<-data.frame(y=y,x=xz[,1],z=xz[,2])
        ##
        m<-glm(y~x*z,df,family="binomial")
        m0<-glm(y~x+z,df,family="binomial")
        pv<-summary(m)$coef[4,4]
        sig[i]<-ifelse(pv<.05,1,0)
        ##
        m.lm<-lm(y~x*z,df)
        pv<-summary(m.lm)$coef[4,4]
        sig.lm[i]<-ifelse(pv<.05,1,0)
        #oos r2
        Noos<-1000
        xz<-mvrnorm(Noos,mu=c(0,0),Sigma=matrix(c(1,rho,rho,1),2,2))
        y<-b0+b1*xz[,1]+b2*xz[,2]+b3*xz[,1]*xz[,2]
        p<-sigma(y)
        y<-rbinom(Noos,1,p)
        df<-data.frame(y=y,x=xz[,1],z=xz[,2])
        yhat<-predict(m,df,type='response')
        y0hat<-predict(m0,df,type='response')
        r2[i]<- (var(y0hat-y)-var(yhat-y))/var(y)
    }
    c(N,rho,b0,b3,mean(sig),mean(sig.lm),mean(r2))
}
library(parallel)
out<-mclapply(pars,simfun,mc.cores=25)
tab<-do.call("rbind",out)

pdf("/home/bd/Dropbox/Apps/Overleaf/Interaction_problems/binary2.pdf",width=6,height=2*2.3)
source("/home/bd/Dropbox/projects/interaction_problems/src/000_functions.R")
bigL<-split(data.frame(tab),tab[,3])
layout(matrix(c(7,1,1,1,4,4,4,7,2,2,2,5,5,5,7,3,3,3,6,6,6),byrow=FALSE,nrow=7,ncol=3))
par(mgp=c(2,1,0),mar=c(3,3,.5,.5))
for (i in 1:length(bigL)) {
    L<-split(data.frame(bigL[[i]]),bigL[[i]][,1])
    for (ii in 1:length(L)) {
        zz<-split(L[[ii]],L[[ii]][,2])
        plot(NULL,xlim=range(tab[,4]),ylim=0:1,xlab=expression(beta[3]),ylab='Discovery Rate',bty='n')
        vert()
        cols<-colorRampPalette(c("red", "blue"))( length(zz))
        for (i in 1:length(zz)) {
            tmp<-zz[[i]]
            ##split by b0
            lines(tmp[,4],tmp[,5],col=cols[i],lwd=2)
            lines(tmp[,4],tmp[,6],col=cols[i],lwd=2,lty=2)
        }
        ##
        legend(0.02,.75,bty='n',paste("N=",unique(tmp[,1]),sep=''),xjust=.5,yjust=.5)
        b0<-unique(tmp[,3])
        legend(0.02,.85,bty='n',
               legend=bquote(beta[0]~"="~.(b0)),
               xjust=.5,yjust=.5)
        abline(h=.8,col='gray')
        if (ii==1) 
            ##
            xx<-L[[ii]]
        mm<-loess(xx[,7]~xx[,4])
        co<-coef(mm)
        vals<-seq(0,max(xx[,4]),by=.1)
        #axis(side=3,at=vals,formatC(predict(mm,vals),digits=0))
        #mtext(side=3,line=2,expression(r^2),cex=.7)
    }
}
par(mar=c(0,0,0,0))
plot(NULL,xlim=0:1,ylim=0:1,bty='n',xaxt='n',yaxt='n',xlab='',ylab='')
legend(xjust=.5,yjust=.5,x=.1,y=.5,bty='n',names(zz),fill=cols,title=expression(rho))
legend(xjust=.5,yjust=.5,x=.3,y=.5,bty='n',lwd=2,lty=c(1,2),c("Logistic","Linear"))
dev.off()


tab <-
structure(c(250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 
250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 
5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 
1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 
250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 
5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 
1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 
250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 
5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 
1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 
250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 
5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 
1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 
250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 
5000, 250, 1000, 5000, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 
0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 
0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 
0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 
0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 
0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 
0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 
0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 
0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 
0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 
0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 
0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 
2, 2, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 2, 
2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 
0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 
0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 
2, 2, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 2, 
2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0.025, 0.025, 0.025, 0.025, 0.025, 0.025, 
0.025, 0.025, 0.025, 0.025, 0.025, 0.025, 0.05, 0.05, 0.05, 0.05, 
0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.075, 0.075, 
0.075, 0.075, 0.075, 0.075, 0.075, 0.075, 0.075, 0.075, 0.075, 
0.075, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 
0.1, 0.125, 0.125, 0.125, 0.125, 0.125, 0.125, 0.125, 0.125, 
0.125, 0.125, 0.125, 0.125, 0.15, 0.15, 0.15, 0.15, 0.15, 0.15, 
0.15, 0.15, 0.15, 0.15, 0.15, 0.15, 0.175, 0.175, 0.175, 0.175, 
0.175, 0.175, 0.175, 0.175, 0.175, 0.175, 0.175, 0.175, 0.2, 
0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.225, 
0.225, 0.225, 0.225, 0.225, 0.225, 0.225, 0.225, 0.225, 0.225, 
0.225, 0.225, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 
0.25, 0.25, 0.25, 0.25, 0.275, 0.275, 0.275, 0.275, 0.275, 0.275, 
0.275, 0.275, 0.275, 0.275, 0.275, 0.275, 0.3, 0.3, 0.3, 0.3, 
0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.053, 0.045, 0.054, 
0.049, 0.046, 0.048, 0.055, 0.04, 0.049, 0.058, 0.045, 0.058, 
0.047, 0.055, 0.096, 0.061, 0.049, 0.069, 0.047, 0.052, 0.097, 
0.055, 0.053, 0.079, 0.045, 0.087, 0.239, 0.059, 0.067, 0.143, 
0.06, 0.074, 0.19, 0.053, 0.055, 0.129, 0.061, 0.126, 0.449, 
0.06, 0.106, 0.276, 0.057, 0.116, 0.323, 0.055, 0.081, 0.235, 
0.087, 0.195, 0.692, 0.067, 0.128, 0.428, 0.061, 0.172, 0.566, 
0.062, 0.113, 0.363, 0.092, 0.24, 0.861, 0.066, 0.183, 0.609, 
0.086, 0.231, 0.712, 0.075, 0.155, 0.539, 0.109, 0.378, 0.95, 
0.086, 0.251, 0.793, 0.129, 0.301, 0.88, 0.095, 0.193, 0.694, 
0.15, 0.487, 0.991, 0.111, 0.293, 0.901, 0.151, 0.375, 0.957, 
0.089, 0.246, 0.827, 0.165, 0.58, 0.996, 0.142, 0.349, 0.952, 
0.157, 0.487, 0.986, 0.124, 0.328, 0.931, 0.205, 0.659, 1, 0.175, 
0.454, 0.986, 0.191, 0.57, 0.999, 0.124, 0.374, 0.97, 0.257, 
0.761, 1, 0.177, 0.539, 0.994, 0.219, 0.659, 1, 0.163, 0.467, 
0.992, 0.301, 0.817, 1, 0.204, 0.605, 1, 0.267, 0.753, 1, 0.189, 
0.547, 0.999, 0.355, 0.893, 1, 0.261, 0.716, 1, 0.314, 0.844, 
1, 0.195, 0.628, 1, 0.031, 0.027, 0.029, 0.025, 0.026, 0.021, 
0.628, 0.994, 1, 0.977, 1, 1, 0.031, 0.027, 0.061, 0.019, 0.027, 
0.028, 0.588, 0.99, 1, 0.959, 1, 1, 0.022, 0.049, 0.166, 0.02, 
0.028, 0.041, 0.524, 0.975, 1, 0.956, 1, 1, 0.029, 0.093, 0.347, 
0.028, 0.045, 0.069, 0.485, 0.959, 1, 0.932, 1, 1, 0.055, 0.146, 
0.578, 0.026, 0.037, 0.106, 0.421, 0.911, 1, 0.926, 1, 1, 0.058, 
0.181, 0.787, 0.037, 0.055, 0.149, 0.386, 0.897, 1, 0.887, 1, 
1, 0.085, 0.285, 0.902, 0.036, 0.064, 0.237, 0.316, 0.828, 1, 
0.863, 1, 1, 0.109, 0.386, 0.977, 0.03, 0.078, 0.321, 0.29, 0.787, 
1, 0.851, 1, 1, 0.113, 0.446, 0.993, 0.048, 0.112, 0.451, 0.253, 
0.679, 1, 0.823, 1, 1, 0.152, 0.55, 1, 0.048, 0.114, 0.551, 0.222, 
0.595, 0.992, 0.785, 0.999, 1, 0.188, 0.667, 1, 0.034, 0.145, 
0.649, 0.181, 0.474, 0.973, 0.745, 0.998, 1, 0.231, 0.733, 1, 
0.062, 0.18, 0.76, 0.143, 0.368, 0.904, 0.713, 0.999, 1, 0.284, 
0.829, 1, 0.073, 0.219, 0.844, 0.142, 0.246, 0.758, 0.669, 0.993, 
1, -0.00315496327471788, -0.000622238549443058, -0.000173559517057529, 
-0.00196460661856451, -0.000511371718601496, -0.000110869477360416, 
-0.00421602672275564, -0.000854694373084827, -0.000240148514385806, 
-0.00321019765927319, -0.000665650174763157, -0.000176769826113462, 
-0.00291790210911537, -0.000617446994204167, -0.000143642356397043, 
-0.00188695047875179, -0.000516423679410493, -0.000116207028316434, 
-0.00463878800749013, -0.00103398932881842, -0.000182631922946758, 
-0.00338566777536977, -0.000643877777533101, -0.000146501634448126, 
-0.00260872863649168, -0.000546624259075166, 4.87716800462068e-05, 
-0.00180129490507768, -0.000450988576061354, -1.93303252632813e-05, 
-0.00422464524368114, -0.000882539422654492, -7.88492256172062e-06, 
-0.00323029026617472, -0.000560785140970828, -6.11676849663183e-05, 
-0.00270362080195433, -0.000159890531393261, 0.0003756392778285, 
-0.00185736762592154, -0.000210302396096026, 5.85952886737745e-05, 
-0.00468373151026717, -0.000724837357460954, 0.000159758653200126, 
-0.00334947016088754, -0.000565177196846463, 5.73836276597132e-05, 
-0.00234639639451684, -1.29336752534323e-05, 0.00072410894883604, 
-0.00171968697586734, -0.000161232103600972, 0.000204740994887181, 
-0.00421565881456348, -0.000485832021085977, 0.000739574663190324, 
-0.00299168660550773, -0.000408788235193828, 0.000195059311643446, 
-0.00170548272248458, 0.000598851190765703, 0.0012702563054406, 
-0.00119954828182076, -9.45040245111542e-05, 0.000381022385275026, 
-0.00364201482418543, 6.62575645676687e-05, 0.00109356389518823, 
-0.00339536747683398, -0.000255799093101909, 0.000448619550532707, 
-0.00113416229462439, 0.00119843894364664, 0.00183024769496673, 
-0.00110208514568401, 0.000159823586744821, 0.000614092897721535, 
-0.00371741567950288, 0.000948008621908848, 0.00180441151798616, 
-0.00402856331508962, -6.72409312385883e-05, 0.000799518362276843, 
-0.000411399448248358, 0.00186583076280954, 0.00247993324145228, 
-0.00107258015811751, 0.000617312215256637, 0.00084202850213449, 
-0.00284653017103351, 0.00199718788028497, 0.00271965323149533, 
-0.00291906736660939, 0.000369837108060192, 0.00122503884922189, 
0.000453642430934624, 0.00275492564800894, 0.00322034465722392, 
-0.000636884551063975, 0.000826317731510059, 0.00117420203090861, 
-0.00190531536960741, 0.00262003653905861, 0.00372961430344151, 
-0.00264029063156768, 0.000738109143156416, 0.00167133059074113, 
0.00112908792700973, 0.00348134811006254, 0.00401938743872908, 
-0.000605369314005691, 0.00125842721391975, 0.00165929699660966, 
-0.000242875632134564, 0.00349014565393326, 0.00483261016966942, 
-0.00238681385436728, 0.00120329057282998, 0.00214196955515081, 
0.00215337811318671, 0.00456049354669439, 0.00534298905819258, 
0.000247315144272599, 0.00154180836650702, 0.00187468148596476, 
0.000480729474604287, 0.00488174378905322, 0.00605849989675172, 
-0.00224438882952648, 0.00188514745839903, 0.00295358687955617, 
0.00342927329455002, 0.00552069701714842, 0.00622960490950164, 
0.000230768666460554, 0.00197658680783291, 0.0023314686745873, 
0.00126375899301228, 0.0066226719299983, 0.0073512696691535, 
-0.00125652665527486, 0.00245797377976285, 0.00352298858900706, 
0.00413069332242389, 0.00672996101825574, 0.0071200741343217, 
0.000777315837257985, 0.00244629743451573, 0.00297994760948833, 
0.00322816223738958, 0.0082135048203681, 0.0090210421236814, 
-0.000123014756855177, 0.0034297513076697, 0.00456990469908151
), .Dim = c(156L, 7L))
