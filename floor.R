##b3=0
N<-c(250,1000,5000)
rho<-c(0,.5) #seq(0,.3,by=.1)
cc<-seq(-3,-1.5,by=.05)
pars<-expand.grid(N=N,rho=rho,cc=cc)
tmp<-list()
for (i in 1:nrow(pars)) tmp[[i]]<-pars[i,]
pars<-tmp


simfun<-function(pars,b1=1,b2=1,s2=1) {
    for (i in 1:length(pars)) assign(names(pars)[i],pars[[i]][1])
    std<-function(x) (x-mean(x,na.rm=TRUE))/sd(x,na.rm=TRUE)
    library(MASS)
    library(censReg)
    sig<-sig.tobit<-r2<-numeric()
    for (i in 1:1000) {
        xz<-mvrnorm(N,mu=c(0,0),Sigma=matrix(c(1,rho,rho,1),2,2))
        y<-b1*xz[,1]+b2*xz[,2]+rnorm(N,sd=sqrt(s2))
        y<-std(y)
        test<-y>cc
        y<-ifelse(test,y,cc)
        ##
        df<-data.frame(y=y,x=xz[,1],z=xz[,2])
        m<-lm(y~x*z,df)
        pv<-summary(m)$coef[4,4]
        sig[i]<-ifelse(pv<.05,1,0)
        ##tobit
        if (!all(test)) {
            m<-censReg(y~x*z,data=df,left=cc)
            pv.tobit<-summary(m)$estimate[4,4]
            sig.tobit[i]<-ifelse(pv.tobit<.05,1,0)
        } else sig.tobit[i]<-sig[i]
    }
    c(N,rho,cc,mean(sig),mean(sig.tobit))
    ##
}
#library(parallel)
#out<-mclapply(pars,simfun,mc.cores=25)
out<-lapply(pars,simfun)
tab<-do.call("rbind",out)

pdf("/home/bd/Dropbox/Apps/Overleaf/Interaction_problems/floor1.pdf",width=6,height=2.3)
source("/home/bd/Dropbox/projects/interaction_problems/src/000_functions.R")
L<-split(data.frame(tab),tab[,1])
layout(matrix(c(4,rep(1,3),4,rep(2,3),4,rep(3,3)),byrow=FALSE,nrow=4,ncol=3))
par(mgp=c(2,1,0),mar=c(3,3,.5,.5))
for (ii in 1:length(L)) {
    zz<-split(L[[ii]],L[[ii]][,2])
    plot(NULL,xlim=c(-3,-1.5),ylim=0:1,xlab='c',ylab='Discovery Rate')
    background()
    cols<-colorRampPalette(c("red", "blue"))( length(zz))
    for (i in 1:length(zz)) {
        tmp<-zz[[i]]
        lines(tmp[,3],tmp[,4],col=cols[i],lwd=2,lty=2)
        lines(tmp[,3],tmp[,5],col=cols[i],lwd=2)
    }
    legend("topleft",bty='n',paste("N=",unique(tmp[,1]),sep=''))
    abline(h=.05,col='gray')
}
par(mar=rep(0,4))
plot(NULL,xlim=0:1,ylim=0:1,bty='n',xaxt='n',yaxt='n',xlab='',ylab='')
legend(xjust=.5,yjust=.5,x=.3,y=0.5,bty='n',names(zz),fill=cols,title=expression(rho))
legend(xjust=.5,yjust=.5,x=.1,y=0.5,bty='n',lwd=2,lty=c(1,2),c("Tobit","Linear"))
dev.off()

tab <-
structure(c(250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 
250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 
5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 
1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 
250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 
5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 
1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 
250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 
5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 
1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 
250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 
5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 
1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 
250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 
5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 
1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 
250, 1000, 5000, 250, 1000, 5000, 250, 1000, 5000, 250, 1000, 
5000, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 
0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 
0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 
0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 
0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 
0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 
0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 
0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 
0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 
0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 
0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 
0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 0, 0, 0, 0.5, 0.5, 0.5, 
-3, -3, -3, -3, -3, -3, -2.9500000000000002, -2.9500000000000002, 
-2.9500000000000002, -2.9500000000000002, -2.9500000000000002, 
-2.9500000000000002, -2.8999999999999999, -2.8999999999999999, 
-2.8999999999999999, -2.8999999999999999, -2.8999999999999999, 
-2.8999999999999999, -2.8500000000000001, -2.8500000000000001, 
-2.8500000000000001, -2.8500000000000001, -2.8500000000000001, 
-2.8500000000000001, -2.7999999999999998, -2.7999999999999998, 
-2.7999999999999998, -2.7999999999999998, -2.7999999999999998, 
-2.7999999999999998, -2.75, -2.75, -2.75, -2.75, -2.75, -2.75, 
-2.7000000000000002, -2.7000000000000002, -2.7000000000000002, 
-2.7000000000000002, -2.7000000000000002, -2.7000000000000002, 
-2.6499999999999999, -2.6499999999999999, -2.6499999999999999, 
-2.6499999999999999, -2.6499999999999999, -2.6499999999999999, 
-2.6000000000000001, -2.6000000000000001, -2.6000000000000001, 
-2.6000000000000001, -2.6000000000000001, -2.6000000000000001, 
-2.5499999999999998, -2.5499999999999998, -2.5499999999999998, 
-2.5499999999999998, -2.5499999999999998, -2.5499999999999998, 
-2.5, -2.5, -2.5, -2.5, -2.5, -2.5, -2.4500000000000002, -2.4500000000000002, 
-2.4500000000000002, -2.4500000000000002, -2.4500000000000002, 
-2.4500000000000002, -2.3999999999999999, -2.3999999999999999, 
-2.3999999999999999, -2.3999999999999999, -2.3999999999999999, 
-2.3999999999999999, -2.3500000000000001, -2.3500000000000001, 
-2.3500000000000001, -2.3500000000000001, -2.3500000000000001, 
-2.3500000000000001, -2.2999999999999998, -2.2999999999999998, 
-2.2999999999999998, -2.2999999999999998, -2.2999999999999998, 
-2.2999999999999998, -2.25, -2.25, -2.25, -2.25, -2.25, -2.25, 
-2.2000000000000002, -2.2000000000000002, -2.2000000000000002, 
-2.2000000000000002, -2.2000000000000002, -2.2000000000000002, 
-2.1499999999999999, -2.1499999999999999, -2.1499999999999999, 
-2.1499999999999999, -2.1499999999999999, -2.1499999999999999, 
-2.1000000000000001, -2.1000000000000001, -2.1000000000000001, 
-2.1000000000000001, -2.1000000000000001, -2.1000000000000001, 
-2.0499999999999998, -2.0499999999999998, -2.0499999999999998, 
-2.0499999999999998, -2.0499999999999998, -2.0499999999999998, 
-2, -2, -2, -2, -2, -2, -1.95, -1.95, -1.95, -1.95, -1.95, -1.95, 
-1.8999999999999999, -1.8999999999999999, -1.8999999999999999, 
-1.8999999999999999, -1.8999999999999999, -1.8999999999999999, 
-1.8499999999999999, -1.8499999999999999, -1.8499999999999999, 
-1.8499999999999999, -1.8499999999999999, -1.8499999999999999, 
-1.7999999999999998, -1.7999999999999998, -1.7999999999999998, 
-1.7999999999999998, -1.7999999999999998, -1.7999999999999998, 
-1.75, -1.75, -1.75, -1.75, -1.75, -1.75, -1.7, -1.7, -1.7, -1.7, 
-1.7, -1.7, -1.6499999999999999, -1.6499999999999999, -1.6499999999999999, 
-1.6499999999999999, -1.6499999999999999, -1.6499999999999999, 
-1.5999999999999999, -1.5999999999999999, -1.5999999999999999, 
-1.5999999999999999, -1.5999999999999999, -1.5999999999999999, 
-1.5499999999999998, -1.5499999999999998, -1.5499999999999998, 
-1.5499999999999998, -1.5499999999999998, -1.5499999999999998, 
-1.5, -1.5, -1.5, -1.5, -1.5, -1.5, 0.050000000000000003, 0.053999999999999999, 
0.050000000000000003, 0.050999999999999997, 0.049000000000000002, 
0.066000000000000003, 0.055, 0.047, 0.052999999999999999, 0.045999999999999999, 
0.050000000000000003, 0.063, 0.042000000000000003, 0.048000000000000001, 
0.052999999999999999, 0.056000000000000001, 0.047, 0.057000000000000002, 
0.049000000000000002, 0.040000000000000001, 0.060999999999999999, 
0.050999999999999997, 0.042000000000000003, 0.071999999999999995, 
0.055, 0.060999999999999999, 0.071999999999999995, 0.047, 0.045999999999999999, 
0.081000000000000003, 0.050000000000000003, 0.049000000000000002, 
0.064000000000000001, 0.044999999999999998, 0.055, 0.089999999999999997, 
0.034000000000000002, 0.060999999999999999, 0.075999999999999998, 
0.050999999999999997, 0.049000000000000002, 0.10299999999999999, 
0.050000000000000003, 0.048000000000000001, 0.079000000000000001, 
0.040000000000000001, 0.060999999999999999, 0.14399999999999999, 
0.044999999999999998, 0.058000000000000003, 0.090999999999999998, 
0.048000000000000001, 0.060999999999999999, 0.152, 0.045999999999999999, 
0.045999999999999999, 0.094, 0.048000000000000001, 0.056000000000000001, 
0.19400000000000001, 0.056000000000000001, 0.068000000000000005, 
0.094, 0.040000000000000001, 0.079000000000000001, 0.23799999999999999, 
0.041000000000000002, 0.051999999999999998, 0.125, 0.052999999999999999, 
0.096000000000000002, 0.28199999999999997, 0.048000000000000001, 
0.060999999999999999, 0.156, 0.045999999999999999, 0.097000000000000003, 
0.34999999999999998, 0.048000000000000001, 0.069000000000000006, 
0.17399999999999999, 0.063, 0.112, 0.41799999999999998, 0.048000000000000001, 
0.070000000000000007, 0.189, 0.071999999999999995, 0.123, 0.49199999999999999, 
0.053999999999999999, 0.094, 0.24299999999999999, 0.057000000000000002, 
0.13600000000000001, 0.63500000000000001, 0.053999999999999999, 
0.085999999999999993, 0.311, 0.053999999999999999, 0.189, 0.73799999999999999, 
0.070000000000000007, 0.089999999999999997, 0.35399999999999998, 
0.058000000000000003, 0.215, 0.83299999999999996, 0.060999999999999999, 
0.11899999999999999, 0.45000000000000001, 0.070999999999999994, 
0.29399999999999998, 0.91000000000000003, 0.066000000000000003, 
0.13600000000000001, 0.52300000000000002, 0.123, 0.32700000000000001, 
0.93200000000000005, 0.050999999999999997, 0.151, 0.60399999999999998, 
0.13400000000000001, 0.38800000000000001, 0.97999999999999998, 
0.073999999999999996, 0.184, 0.69499999999999995, 0.128, 0.47499999999999998, 
0.99099999999999999, 0.089999999999999997, 0.23499999999999999, 
0.79500000000000004, 0.152, 0.53100000000000003, 0.995, 0.123, 
0.27000000000000002, 0.85199999999999998, 0.19600000000000001, 
0.66000000000000003, 0.999, 0.095000000000000001, 0.308, 0.91900000000000004, 
0.23499999999999999, 0.71599999999999997, 1, 0.10000000000000001, 
0.32600000000000001, 0.95299999999999996, 0.26200000000000001, 
0.81100000000000005, 1, 0.13500000000000001, 0.41699999999999998, 
0.97299999999999998, 0.28100000000000003, 0.877, 1, 0.121, 0.46999999999999997, 
0.99299999999999999, 0.35599999999999998, 0.92100000000000004, 
1, 0.16600000000000001, 0.54000000000000004, 0.998, 0.42899999999999999, 
0.94299999999999995, 1, 0.17399999999999999, 0.59899999999999998, 
1, 0.48799999999999999, 0.97299999999999998, 1, 0.19500000000000001, 
0.67300000000000004, 1, 0.53800000000000003, 0.98799999999999999, 
1, 0.052999999999999999, 0.053999999999999999, 0.049000000000000002, 
0.057000000000000002, 0.058999999999999997, 0.050999999999999997, 
0.058000000000000003, 0.055, 0.055, 0.052999999999999999, 0.057000000000000002, 
0.049000000000000002, 0.047, 0.055, 0.055, 0.070999999999999994, 
0.045999999999999999, 0.048000000000000001, 0.052999999999999999, 
0.042999999999999997, 0.057000000000000002, 0.049000000000000002, 
0.044999999999999998, 0.056000000000000001, 0.058999999999999997, 
0.063, 0.062, 0.056000000000000001, 0.042000000000000003, 0.047, 
0.057000000000000002, 0.051999999999999998, 0.048000000000000001, 
0.050000000000000003, 0.058999999999999997, 0.037999999999999999, 
0.033000000000000002, 0.065000000000000002, 0.057000000000000002, 
0.057000000000000002, 0.049000000000000002, 0.056000000000000001, 
0.051999999999999998, 0.050999999999999997, 0.051999999999999998, 
0.048000000000000001, 0.049000000000000002, 0.057000000000000002, 
0.045999999999999999, 0.057000000000000002, 0.060999999999999999, 
0.050999999999999997, 0.044999999999999998, 0.044999999999999998, 
0.056000000000000001, 0.040000000000000001, 0.050999999999999997, 
0.050999999999999997, 0.035999999999999997, 0.055, 0.052999999999999999, 
0.056000000000000001, 0.049000000000000002, 0.044999999999999998, 
0.044999999999999998, 0.048000000000000001, 0.044999999999999998, 
0.045999999999999999, 0.048000000000000001, 0.045999999999999999, 
0.066000000000000003, 0.058999999999999997, 0.051999999999999998, 
0.042999999999999997, 0.063, 0.053999999999999999, 0.060999999999999999, 
0.044999999999999998, 0.060999999999999999, 0.057000000000000002, 
0.040000000000000001, 0.058999999999999997, 0.050999999999999997, 
0.037999999999999999, 0.060999999999999999, 0.043999999999999997, 
0.044999999999999998, 0.042000000000000003, 0.042999999999999997, 
0.055, 0.064000000000000001, 0.055, 0.049000000000000002, 0.051999999999999998, 
0.049000000000000002, 0.050999999999999997, 0.049000000000000002, 
0.042000000000000003, 0.045999999999999999, 0.045999999999999999, 
0.050000000000000003, 0.042000000000000003, 0.060999999999999999, 
0.053999999999999999, 0.052999999999999999, 0.050000000000000003, 
0.055, 0.041000000000000002, 0.057000000000000002, 0.058999999999999997, 
0.063, 0.049000000000000002, 0.056000000000000001, 0.042999999999999997, 
0.063, 0.050000000000000003, 0.040000000000000001, 0.067000000000000004, 
0.044999999999999998, 0.043999999999999997, 0.034000000000000002, 
0.047, 0.049000000000000002, 0.053999999999999999, 0.049000000000000002, 
0.050999999999999997, 0.042000000000000003, 0.047, 0.035999999999999997, 
0.050999999999999997, 0.042000000000000003, 0.041000000000000002, 
0.056000000000000001, 0.035999999999999997, 0.035999999999999997, 
0.057000000000000002, 0.053999999999999999, 0.045999999999999999, 
0.059999999999999998, 0.047, 0.049000000000000002, 0.056000000000000001, 
0.048000000000000001, 0.064000000000000001, 0.052999999999999999, 
0.045999999999999999, 0.049000000000000002, 0.043999999999999997, 
0.034000000000000002, 0.044999999999999998, 0.053999999999999999, 
0.045999999999999999, 0.058999999999999997, 0.051999999999999998, 
0.048000000000000001, 0.044999999999999998, 0.049000000000000002, 
0.058999999999999997, 0.058000000000000003, 0.050000000000000003, 
0.052999999999999999, 0.050000000000000003, 0.050000000000000003, 
0.050999999999999997, 0.042000000000000003, 0.071999999999999995, 
0.055, 0.047, 0.058999999999999997, 0.040000000000000001, 0.051999999999999998, 
0.043999999999999997, 0.042999999999999997, 0.047, 0.048000000000000001, 
0.047, 0.043999999999999997, 0.057000000000000002, 0.058000000000000003, 
0.055, 0.053999999999999999, 0.055, 0.058999999999999997, 0.050999999999999997, 
0.059999999999999998, 0.044999999999999998), .Dim = c(186L, 5L
))


## ##b3!=0
## N<-c(250,1000,5000)
## rho<-c(0,.5) #seq(0,.3,by=.1)
## cc<- -2 #seq(-3,-1.5,by=.05)
## b3<-seq(0,.15,by=.01)
## pars<-expand.grid(N=N,rho=rho,cc=cc,b3=b3)
## tmp<-list()
## for (i in 1:nrow(pars)) tmp[[i]]<-pars[i,]
## pars<-tmp


## simfun<-function(pars,b1=1,b2=1,s2=1) {
##     for (i in 1:length(pars)) assign(names(pars)[i],pars[[i]][1])
##     std<-function(x) (x-mean(x,na.rm=TRUE))/sd(x,na.rm=TRUE)
##     library(MASS)
##     sig<-r2<-numeric()
##     for (i in 1:1000) {
##         xz<-mvrnorm(N,mu=c(0,0),Sigma=matrix(c(1,rho,rho,1),2,2))
##         y<-b1*xz[,1]+b2*xz[,2]+rnorm(N,sd=sqrt(s2))+b3*xz[,1]*xz[,2]
##         y<-std(y)
##         y<-ifelse(y>cc,y,cc)
##         print(sum(y<=cc)/length(y))##
##         df<-data.frame(y=y,x=xz[,1],z=xz[,2])
##         m<-lm(y~x*z,df)
##         pv<-summary(m)$coef[4,4]
##         sig[i]<-ifelse(pv<.05,1,0)
##     }
##     c(N,rho,cc,b3,mean(sig))
##     ##
## }
## library(parallel)
## out<-mclapply(pars,simfun,mc.cores=25)
## tab<-do.call("rbind",out)

## pdf("/home/bd/Dropbox/Apps/Overleaf/Interaction_problems/floor2.pdf",width=8,height=3)
## source("/home/bd/Dropbox/projects/interaction_problems/src/000_functions.R")
## L<-split(data.frame(tab),tab[,1])
## par(mgp=c(2,1,0),mfrow=c(1,3),mar=c(3,3,1,1))
## for (ii in 1:length(L)) {
##     zz<-split(L[[ii]],L[[ii]][,2])
##     plot(NULL,xlim=c(0,.15),ylim=0:1,xlab='b3',ylab='Power')
##     vert()
##     cols<-colorRampPalette(c("red", "blue"))( length(zz))
##     for (i in 1:length(zz)) {
##         tmp<-zz[[i]]
##         lines(tmp[,4],tmp[,5],col=cols[i],lwd=2)
##     }
##     legend("topleft",bty='n',paste("N=",unique(tmp[,1]),sep=''))
##     legend("bottomright",bty='n',names(zz),fill=cols,title=expression(rho))
##     abline(h=.8,col='gray')
## }
## dev.off()
